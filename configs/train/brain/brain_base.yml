precision: &precision float
toolbox: # defines yaml placeholders
  nnum: &nnum 19
  z_out: &z_out 49
  ls_z_min: &ls_z_min 60
  ls_z_max: &ls_z_max 181
  meta: &meta {z_ls_rescaled: 241, pred_z_min: 142, pred_z_max: 620, scale: &scale 4, shrink: &shrink 8, interpolation_order: 2, nnum: *nnum, z_out: *z_out, crop_names: [gcamp]}
  metrics: &metrics
    MS_SSIM: {tensor_names: {y_pred: pred, y: ls_trf}, data_range: 1, size_average: true, win_size: 11, win_sigma: 1.5, channel: 1, spatial_dims: 2}
    SSIM: {tensor_names: {y_pred: pred, y: ls_trf}, data_range: 1, size_average: true, win_size: 11, win_sigma: 1.5, channel: 1, spatial_dims: 2}
    NRMSE: {tensor_names: {y_pred: pred, y: ls_slice}}
    PSNR: {tensor_names: {y_pred: pred, y: ls_slice}, data_range: null}
    SmoothL1Loss: {tensor_names: {y_pred: pred, y: ls_slice}}
    MSELoss: {tensor_names: {y_pred: pred, y: ls_slice}}

  eval_batch_size: &eval_batch_size 2
  eval_sample_prepr: &eval_sample_prepr
    - CropWhatShrinkDoesNot: {apply_to: lf, meta: *meta, wrt_ref: true}
    - CropLSforDynamicTraining: {apply_to: ls_slice, meta: *meta}
    - Normalize01: {apply_to: lf, min_percentile: 5.0, max_percentile: 99.8}
    - Normalize01: {apply_to: ls_slice, min_percentile: 5.0, max_percentile: 99.99}
    - ChannelFromLightField: {apply_to: {lf: lfc}, nnum: *nnum}
  eval_batch_prepr: &eval_batch_prepr []
  batch_prepr_in_step: &batch_prepr_in_step
    - Cast: {apply_to: [lfc, ls_slice], dtype: *precision, device: cuda, non_blocking: true}
  batch_postpr: &batch_postpr
    - Assert: {apply_to: pred, expected_tensor_shape: [null, 1, *z_out, null, null]}
    - AffineTransformationDynamicTraining: {apply_to: pred, target_to_compare_to: ls_slice, meta: *meta}

model:
  name: A04
  kwargs:
    scale: *scale
    shrink: *shrink
    input_name: lfc
    prediction_name: pred
    nnum: *nnum
    z_out: *z_out
    n_res2d: [488, 488, u, 244, 244]
  checkpoint:

stages:
  - train:
      max_epochs: 500
      metrics: {}
      log:
        save_n_checkpoints: 3
        TqdmLogger: {}
        TensorBoardLogger:
          scalars_every: {value: 10, unit: iteration}
          tensors_every: {value: 500, unit: iteration}
          tensor_names: [lf, pred, ls_slice, WeightedSmoothL1Loss_pixelwise]
        FileLogger:
          scalars_every: {value: 1, unit: epoch}

      criterion:
        name: WeightedSmoothL1Loss
        kwargs: {threshold: 1.0, initial_weight: 5.0, apply_below_threshold: false, decay_by: 1.0, every_nth_epoch: 1}
        tensor_names: {input: pred, target: ls_slice}

      optimizer:
        name: Adam
        kwargs: {lr: 2.0e-4, eps: 1.0e-8}

      sampler:
        base: RandomSampler
        drop_last: false

      batch_preprocessing:
        - RandomRotate90: {apply_to: [lf, ls_slice]}
        - ChannelFromLightField: {apply_to: {lf: lfc}, nnum: *nnum}
      batch_preprocessing_in_step: *batch_prepr_in_step
      batch_postprocessing: *batch_postpr
      batch_multiplier: 1
      data:
        - batch_size: 2
          sample_preprocessing:
            - CropWhatShrinkDoesNot: {apply_to: lf, meta: *meta, wrt_ref: true}
            - CropLSforDynamicTraining: {apply_to: ls_slice, meta: *meta}
            - Normalize01: {apply_to: lf, min_percentile: 5.0, max_percentile: 99.8}
            - Normalize01: {apply_to: ls_slice, min_percentile: 5.0, max_percentile: 99.99}
            - AdditiveGaussianNoise: {apply_to: lf, sigma: 0.1}
            - AdditiveGaussianNoise: {apply_to: ls_slice, sigma: 0.05}
            - RandomIntensityScale: {apply_to: [lf, ls_slice], factor_min: .8, factor_max: 1.2}
            - RandomlyFlipAxis: {apply_to: [lf, ls_slice], axis: -1}
            - RandomlyFlipAxis: {apply_to: [lf, ls_slice], axis: -2}
          filters: [[z_range, {z_min: *ls_z_min, z_max: *ls_z_max}], [signal2noise, {apply_to: ls_slice, signal_percentile: 99.9, noise_percentile: 5.0, ratio: 1.3}]]
          datasets:
#             - {tensors: {meta: *meta, lf: brain.09_2__2020-03-09_06.05.11__SwipeThrough_-390_-270_nimages_13, ls_slice: brain.09_2__2020-03-09_06.05.11__SwipeThrough_-390_-270_nimages_13},indices: 0-13}  # 13 fish_09_2, quality *** (fires like crazy)
#             - {tensors: {meta: *meta, lf: brain.09_2__2020-03-09_06.05.11__SwipeThrough_-450_-210_nimages_241, ls_slice: brain.09_2__2020-03-09_06.05.11__SwipeThrough_-450_-210_nimages_241},indices: 0-482}  # 482
#             - {tensors: {meta: *meta, lf: brain.09_2__2020-03-09_06.15.03__SwipeThrough_-390_-270_nimages_13, ls_slice: brain.09_2__2020-03-09_06.15.03__SwipeThrough_-390_-270_nimages_13},indices: 0-26}  # 26
#             - {tensors: {meta: *meta, lf: brain.09_2__2020-03-09_06.15.03__SwipeThrough_-450_-210_nimages_241, ls_slice: brain.09_2__2020-03-09_06.15.03__SwipeThrough_-450_-210_nimages_241},indices: 0-723}  # 723
#             - {tensors: {meta: *meta, lf: brain.09_2__2020-03-09_06.17.56__SwipeThrough_-390_-270_nimages_13, ls_slice: brain.09_2__2020-03-09_06.17.56__SwipeThrough_-390_-270_nimages_13},indices: 0-39}  # 39
#             - {tensors: {meta: *meta, lf: brain.09_2__2020-03-09_06.17.56__SwipeThrough_-450_-210_nimages_241, ls_slice: brain.09_2__2020-03-09_06.17.56__SwipeThrough_-450_-210_nimages_241},indices: 1-723}  # 723
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_07.14.47__SwipeThrough_-390_-270_nimages_13, ls_slice: brain.09_4__2020-03-09_07.14.47__SwipeThrough_-390_-270_nimages_13},indices: 0-13}  # 13 fish_09_4, not so much going on  # ...
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_07.14.47__SwipeThrough_-450_-210_nimages_241, ls_slice: brain.09_4__2020-03-09_07.14.47__SwipeThrough_-450_-210_nimages_241},indices: 0-241}  # 241
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_07.26.02__SwipeThrough_-390_-270_nimages_13, ls_slice: brain.09_4__2020-03-09_07.26.02__SwipeThrough_-390_-270_nimages_13},indices: 0-13}  # 13
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_07.26.02__SwipeThrough_-450_-210_nimages_241, ls_slice: brain.09_4__2020-03-09_07.26.02__SwipeThrough_-450_-210_nimages_241},indices: 0-241}  # 241
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_07.30.14__SwipeThrough_-450_-210_nimages_241, ls_slice: brain.09_4__2020-03-09_07.30.14__SwipeThrough_-450_-210_nimages_241},indices: 0-241}  # 241
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_07.50.51__SwipeThrough_-390_-270_nimages_13, ls_slice: brain.09_4__2020-03-09_07.50.51__SwipeThrough_-390_-270_nimages_13},indices: 0-13}  # 13
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_07.51.52__SwipeThrough_-390_-270_nimages_13, ls_slice: brain.09_4__2020-03-09_07.51.52__SwipeThrough_-390_-270_nimages_13},indices: 0-13}  # 13
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.20.04__SwipeThrough_-390_-270_nimages_25, ls_slice: brain.09_4__2020-03-09_08.20.04__SwipeThrough_-390_-270_nimages_25},indices: 0-25}  # 25
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.20.04__SwipeThrough_-450_-210_nimages_241, ls_slice: brain.09_4__2020-03-09_08.20.04__SwipeThrough_-450_-210_nimages_241},indices: 0-241}  # 241
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.21.40__SwipeThrough_-390_-270_nimages_25, ls_slice: brain.09_4__2020-03-09_08.21.40__SwipeThrough_-390_-270_nimages_25},indices: 0-350}  # 350
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.21.40__SwipeThrough_-450_-210_nimages_241, ls_slice: brain.09_4__2020-03-09_08.21.40__SwipeThrough_-450_-210_nimages_241},indices: 0-300|300-1324-3|1325-2650-3|2651-3374-3}  # 3374
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.31.10__SwipeThrough_-450_-210_nimages_49, ls_slice: brain.09_4__2020-03-09_08.31.10__SwipeThrough_-450_-210_nimages_49},indices: 0-105|105-717-4|718-1329-4|1330-1941-4|1942-2450-4}  # 2450
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.53.20__SwipeThrough_-450_-210_nimages_49, ls_slice: brain.09_4__2020-03-09_08.53.20__SwipeThrough_-450_-210_nimages_49},indices: 0-49}  # 49
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.06.55__SwipeThrough_-450_-210_nimages_49, ls_slice: brain.09_4__2020-03-09_09.06.55__SwipeThrough_-450_-210_nimages_49},indices: 0-105|106-717-4|719-1329-4|1331-1941-4|1943-2450-4|2451-3267-3|3268-4083-3|4084-4900-3}  # 4900
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.41.22__SinglePlane_-330, ls_slice: brain.09_4__2020-03-09_08.41.22__SinglePlane_-330},indices: 0-10|10-600-10}  # 600
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.41.22__SinglePlane_-340, ls_slice: brain.09_4__2020-03-09_08.41.22__SinglePlane_-340},indices: 0-10|11-600-10}  # 600
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.41.22__SinglePlane_-350, ls_slice: brain.09_4__2020-03-09_08.41.22__SinglePlane_-350},indices: 0-10|12-600-10}  # 600
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.41.22__SinglePlane_-360, ls_slice: brain.09_4__2020-03-09_08.41.22__SinglePlane_-360},indices: 0-10|13-600-10}  # 600
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.41.22__SinglePlane_-320, ls_slice: brain.09_4__2020-03-09_08.41.22__SinglePlane_-320},indices: 0-10|14-600-10}  # 600
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.41.22__SinglePlane_-310, ls_slice: brain.09_4__2020-03-09_08.41.22__SinglePlane_-310},indices: 0-10|15-600-10}  # 600
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.41.22__SinglePlane_-300, ls_slice: brain.09_4__2020-03-09_08.41.22__SinglePlane_-300},indices: 0-10|16-600-10}  # 600
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.56.54__SinglePlane_-330, ls_slice: brain.09_4__2020-03-09_08.56.54__SinglePlane_-330},indices: 0-10|17-600-10}  # 600
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-290, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-290},indices: 0-10|18-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-390, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-390},indices: 0-10|19-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-380, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-380},indices: 0-10|10-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-280, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-280},indices: 0-10|11-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-270, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-270},indices: 0-10|12-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-385, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-385},indices: 0-10|13-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-375, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-375},indices: 0-10|14-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-365, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-365},indices: 0-10|15-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-355, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-355},indices: 0-10|16-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-345, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-345},indices: 0-10|17-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-335, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-335},indices: 0-10|18-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-325, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-325},indices: 0-10|19-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-315, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-315},indices: 0-10|20-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-295, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-295},indices: 0-10|21-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-285, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-285},indices: 0-10|22-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-275, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-275},indices: 0-10|23-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-305, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-305},indices: 0-10|24-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-330, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-330},indices: 0-10|25-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-340, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-340},indices: 0-10|26-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-350, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-350},indices: 0-10|27-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-360, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-360},indices: 0-10|28-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-370, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-370},indices: 0-10|29-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-320, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-320},indices: 0-10|10-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-310, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-310},indices: 0-10|13-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-300, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-300},indices: 0-10|16-1200-20}  # 1200
#             - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_07.53.40__SinglePlane_-330, ls_slice: brain.09_4__2020-03-09_07.53.40__SinglePlane_-330},indices: 0-10|19-600-10}  # 600
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_07.34.47__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_07.34.47__SwipeThrough_-390_-270_nimages_121},indices: null}  # 9680 fish_11_2
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.52.33__SwipeThrough_-450_-210_nimages_241, ls_slice: brain.11_2__2020-03-11_08.52.33__SwipeThrough_-450_-210_nimages_241},indices: null}  # 7230
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_09.08.00__SwipeThrough_-450_-210_nimages_241, ls_slice: brain.11_2__2020-03-11_09.08.00__SwipeThrough_-450_-210_nimages_241},indices: null}  # 3615
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.30.21__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.30.21__SwipeThrough_-390_-270_nimages_121},indices: null}  # 968
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.34.19__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.34.19__SwipeThrough_-390_-270_nimages_121},indices: null}  # 968
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.36.58__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.36.58__SwipeThrough_-390_-270_nimages_121},indices: null}  # 968
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.39.31__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.39.31__SwipeThrough_-390_-270_nimages_121},indices: null}  # 968
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.42.07__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.42.07__SwipeThrough_-390_-270_nimages_121},indices: null}  # 968
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.44.50__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.44.50__SwipeThrough_-390_-270_nimages_121},indices: null}  # 968
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.47.29__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.47.29__SwipeThrough_-390_-270_nimages_121},indices: null}  # 968
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.19.37__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.19.37__SwipeThrough_-390_-270_nimages_121},indices: null}  # 121
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.20.29__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.20.29__SwipeThrough_-390_-270_nimages_121},indices: null}  # 121
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.22.19__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.22.19__SwipeThrough_-390_-270_nimages_121},indices: null}  # 605
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_06.55.38__SwipeThrough_-450_-210_nimages_121, ls_slice: brain.11_2__2020-03-11_06.55.38__SwipeThrough_-450_-210_nimages_121},indices: null}  # 242
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_06.57.26__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_06.57.26__SwipeThrough_-390_-270_nimages_121},indices: null}  # 6534
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.06.25__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_10.06.25__SwipeThrough_-390_-270_nimages_121},indices: null}  # 121
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_09.35.16__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_09.35.16__SwipeThrough_-390_-270_nimages_121},indices: null}  # 121
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_09.36.25__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_09.36.25__SwipeThrough_-390_-270_nimages_121},indices: null}  # 2904
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_09.47.38__SwipeThrough_-450_-210_nimages_121, ls_slice: brain.11_2__2020-03-11_09.47.38__SwipeThrough_-450_-210_nimages_121},indices: null}  # 2904
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_09.54.35__SwipeThrough_-450_-210_nimages_121, ls_slice: brain.11_2__2020-03-11_09.54.35__SwipeThrough_-450_-210_nimages_121},indices: null}  # 3630

      validate:
        metrics: *metrics
        log:
          TqdmLogger: {}
          TensorBoardLogger:
            scalars_every: {value: 1, unit: epoch}
            tensors_every: {value: 1, unit: epoch}
            tensor_names: [lf, pred, ls]
          FileLogger:
            scalars_every: {value: 1, unit: epoch}
        score_metric: MS_SSIM
        period: {value: 500, unit: iteration}
        patience: 30
        batch_preprocessing: *eval_batch_prepr
        batch_preprocessing_in_step: *batch_prepr_in_step
        batch_postprocessing: *batch_postpr
        data:
          - batch_size: *eval_batch_size
            sample_preprocessing: *eval_sample_prepr
            filters: [[z_range, {z_min: *ls_z_min, z_max: *ls_z_max}]]
            datasets:
              - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_06.53.14__SinglePlane_-330, ls_slice: brain.11_2__2020-03-11_06.53.14__SinglePlane_-330}}
#               - {tensors: {meta: *meta, lf: brain.09_1__2020-03-09_02.53.02__SwipeThrough_-450_-210_nimages_241, ls_slice: brain.09_1__2020-03-09_02.53.02__SwipeThrough_-450_-210_nimages_241},indices: 0-241-5} # 1205

  - test_individually:
      metrics: *metrics
      log:
        TqdmLogger: {}
        TensorBoardLogger:
          scalars_every: {value: 1, unit: epoch}
          tensors_every: {value: 1, unit: epoch}
        FileLogger:
          scalars_every: {value: 1, unit: epoch}
          tensors_every: {value: 1, unit: iteration}
          tensor_names: {lf, ls_slice, pred}
      batch_preprocessing: *eval_batch_prepr
      batch_preprocessing_in_step: *batch_prepr_in_step
      batch_postprocessing: *batch_postpr
      data:
        - batch_size: *eval_batch_size
          sample_preprocessing: *eval_sample_prepr
          filters: [[z_range, {z_min: *ls_z_min, z_max: *ls_z_max}]]

      datasets:
        - {tensors: {meta: *meta, lf: brain.09_3__2020-03-09_06.43.40__SinglePlane_-330, ls_slice: brain.09_3__2020-03-09_06.43.40__SinglePlane_-330},indices: 400-600}  # 1200 crazy crazy  # blinking
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_07.30.39__SinglePlane_-320, ls_slice: brain.11_2__2020-03-11_07.30.39__SinglePlane_-320}}
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_07.30.39__SinglePlane_-310, ls_slice: brain.11_2__2020-03-11_07.30.39__SinglePlane_-310}}
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.13.20__SinglePlane_-290, ls_slice: brain.11_2__2020-03-11_10.13.20__SinglePlane_-290}}
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.13.20__SinglePlane_-315, ls_slice: brain.11_2__2020-03-11_10.13.20__SinglePlane_-315}}
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.25.41__SinglePlane_-295, ls_slice: brain.11_2__2020-03-11_10.25.41__SinglePlane_-295}}
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.25.41__SinglePlane_-305, ls_slice: brain.11_2__2020-03-11_10.25.41__SinglePlane_-305}}
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.25.41__SinglePlane_-340, ls_slice: brain.11_2__2020-03-11_10.25.41__SinglePlane_-340}}
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.17.34__SinglePlane_-280, ls_slice: brain.11_2__2020-03-11_10.17.34__SinglePlane_-280}}
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.17.34__SinglePlane_-330, ls_slice: brain.11_2__2020-03-11_10.17.34__SinglePlane_-330}}
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.21.14__SinglePlane_-295, ls_slice: brain.11_2__2020-03-11_10.21.14__SinglePlane_-295}}
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.21.14__SinglePlane_-305, ls_slice: brain.11_2__2020-03-11_10.21.14__SinglePlane_-305}}
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.12.13__SinglePlane_-310, ls_slice: brain.11_2__2020-03-11_08.12.13__SinglePlane_-310}}
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_06.53.14__SinglePlane_-330, ls_slice: brain.11_2__2020-03-11_06.53.14__SinglePlane_-330}}
