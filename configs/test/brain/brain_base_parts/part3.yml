
toolbox: # defines yaml placeholders
  precision: &precision float
  nnum: &nnum 19
  z_out: &z_out 49
  meta: &meta {nnum: *nnum, z_out: *z_out, scale: &scale 4, shrink: &shrink 8, interpolation_order: 2, z_ls_rescaled: 241, pred_z_min: 142, pred_z_max: 620, crop_names: &crop_names [gcamp]}  # z_min full: 0, z_max full: 838; 60/209*838=241; 838-10/209*838=798
  eval_batch_size: &eval_batch_size 1
  sample_trfs: &sample_trfs []
  eval_sample_prepr_dynamic: &eval_sample_prepr_dynamic
    - CropWhatShrinkDoesNot: {apply_to: lf, meta: *meta, wrt_ref: true}
    - CropLSforDynamicTraining: {apply_to: ls_slice, meta: *meta}
    - Normalize01: {apply_to: lf, min_percentile: 5.0, max_percentile: 99.8}
    - Normalize01: {apply_to: ls_slice, min_percentile: 5.0, max_percentile: 99.99}
    - ChannelFromLightField: {apply_to: {lf: lfc}, nnum: *nnum}
  train_sample_prepr_dynamic: &train_sample_prepr_dynamic
    - CropWhatShrinkDoesNot: {apply_to: lf, meta: *meta, wrt_ref: true}
    - CropLSforDynamicTraining: {apply_to: ls_slice, meta: *meta}
    - Normalize01: {apply_to: lf, min_percentile: 5.0, max_percentile: 99.8}
    - Normalize01: {apply_to: ls_slice, min_percentile: 5.0, max_percentile: 99.99}
    - AdditiveGaussianNoise: {apply_to: lf, sigma: 0.1}
    - AdditiveGaussianNoise: {apply_to: ls_slice, sigma: 0.05}
    - RandomIntensityScale: {apply_to: [lf, ls_slice], factor_min: .8, factor_max: 1.2}
    - RandomlyFlipAxis: {apply_to: [lf, ls_slice], axis: -1}
    - RandomlyFlipAxis: {apply_to: [lf, ls_slice], axis: -2}
  eval_batch_prepr: &eval_batch_prepr []
  train_batch_prepr: &train_batch_prepr
    - RandomRotate90: {apply_to: [lf, ls_slice]}
    - ChannelFromLightField: {apply_to: {lf: lfc}, nnum: *nnum}
  batch_prepr_in_step_dynamic: &batch_prepr_in_step_dynamic
    - Cast: {apply_to: [lfc, ls_slice], dtype: *precision, device: cuda, non_blocking: true}
  batch_postpr_dynamic: &batch_postpr_dynamic
    - Cast: {apply_to: lfc, dtype: *precision, device: cpu, non_blocking: true}
    - Assert: {apply_to: pred, expected_tensor_shape: [1, *z_out, null, null]}
    - AffineTransformationDynamicTraining: {apply_to: pred, target_to_compare_to: ls_slice, meta: *meta}

  train_filter_dynamic: &train_filter_dynamic []
  eval_filter_dynamic: &eval_filter_dynamic []

model:
  name: A04
  kwargs:
    scale: *scale
    shrink: *shrink
    input_name: lfc
    prediction_name: pred
    nnum: *nnum
    z_out: *z_out
    n_res2d: [488, 488, u, 244, 244]

  checkpoint: "/g/kreshuk/LF_computed/lnet/logs/brain1/z_out49/f4_b2_only11_2/20-06-06_17-59-42/train/run000/checkpoints/v1_checkpoint_37500_MS_SSIM=0.8822072593371073.pth"

stages:
  - training_scores:
      metrics: brain.yml
      log:
        TqdmLogger: {}
        FileLogger:
          scalars_every: {value: 1, unit: iteration}
#          tensors_every: {value: 1, unit: iteration}
#          tensor_names: {ls_slice, pred}
      batch_preprocessing: *eval_batch_prepr
      batch_preprocessing_in_step: *batch_prepr_in_step_dynamic
      batch_postprocessing: *batch_postpr_dynamic
      data:
        - batch_size: *eval_batch_size
          sample_transformations: *sample_trfs
          sample_preprocessing: *eval_sample_prepr_dynamic
          filters: [[z_range, {}], [signal2noise, {apply_to: ls_slice, signal_percentile: 99.9, noise_percentile: 5.0, ratio: 1.3}]]
          datasets:
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_07.34.47__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_07.34.47__SwipeThrough_-390_-270_nimages_121},indices: null}  # 9680 fish_11_2
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.52.33__SwipeThrough_-450_-210_nimages_241, ls_slice: brain.11_2__2020-03-11_08.52.33__SwipeThrough_-450_-210_nimages_241},indices: null}  # 7230
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_09.08.00__SwipeThrough_-450_-210_nimages_241, ls_slice: brain.11_2__2020-03-11_09.08.00__SwipeThrough_-450_-210_nimages_241},indices: null}  # 3615
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.30.21__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.30.21__SwipeThrough_-390_-270_nimages_121},indices: null}  # 968
            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.34.19__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.34.19__SwipeThrough_-390_-270_nimages_121},indices: null}  # 968
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.36.58__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.36.58__SwipeThrough_-390_-270_nimages_121},indices: null}  # 968
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.39.31__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.39.31__SwipeThrough_-390_-270_nimages_121},indices: null}  # 968
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.42.07__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.42.07__SwipeThrough_-390_-270_nimages_121},indices: null}  # 968
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.44.50__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.44.50__SwipeThrough_-390_-270_nimages_121},indices: null}  # 968
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.47.29__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.47.29__SwipeThrough_-390_-270_nimages_121},indices: null}  # 968
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.19.37__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.19.37__SwipeThrough_-390_-270_nimages_121},indices: null}  # 121
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.20.29__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.20.29__SwipeThrough_-390_-270_nimages_121},indices: null}  # 121
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.22.19__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_08.22.19__SwipeThrough_-390_-270_nimages_121},indices: null}  # 605
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_06.55.38__SwipeThrough_-450_-210_nimages_121, ls_slice: brain.11_2__2020-03-11_06.55.38__SwipeThrough_-450_-210_nimages_121},indices: null}  # 242
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_06.57.26__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_06.57.26__SwipeThrough_-390_-270_nimages_121},indices: null}  # 6534
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.06.25__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_10.06.25__SwipeThrough_-390_-270_nimages_121},indices: null}  # 121
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_09.35.16__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_09.35.16__SwipeThrough_-390_-270_nimages_121},indices: null}  # 121
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_09.36.25__SwipeThrough_-390_-270_nimages_121, ls_slice: brain.11_2__2020-03-11_09.36.25__SwipeThrough_-390_-270_nimages_121},indices: null}  # 2904
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_09.47.38__SwipeThrough_-450_-210_nimages_121, ls_slice: brain.11_2__2020-03-11_09.47.38__SwipeThrough_-450_-210_nimages_121},indices: null}  # 2904
#            - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_09.54.35__SwipeThrough_-450_-210_nimages_121, ls_slice: brain.11_2__2020-03-11_09.54.35__SwipeThrough_-450_-210_nimages_121},indices: null}  # 3630
