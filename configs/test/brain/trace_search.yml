toolbox: # defines yaml placeholders
  nnum: &nnum 19
  z_out: &z_out 49
  meta: &meta {z_ls_rescaled: 241, pred_z_min: 142, pred_z_max: 620, scale: &scale 4, shrink: &shrink 8, interpolation_order: 2, nnum: *nnum, z_out: *z_out, crop_names: [gcamp]}
  metrics: &metrics brain.yml

  eval_batch_size: &eval_batch_size 8
  eval_sample_prepr: &eval_sample_prepr
    - CropWhatShrinkDoesNot: {apply_to: lf, meta: *meta, wrt_ref: true}
    - CropLSforDynamicTraining: {apply_to: ls_slice, meta: *meta}
    - Normalize01: {apply_to: lf, min_percentile: 5.0, max_percentile: 99.8}
    - Normalize01: {apply_to: ls_slice, min_percentile: 5.0, max_percentile: 99.99}
    - ChannelFromLightField: {apply_to: {lf: lfc}, nnum: *nnum}
  eval_batch_prepr: &eval_batch_prepr []
  batch_prepr_in_step: &batch_prepr_in_step
    - Cast: {apply_to: [lfc, ls_slice], dtype: float32, device: cuda, non_blocking: true}
  batch_postpr: &batch_postpr
    - Assert: {apply_to: {pred: pred_vol}, expected_tensor_shape: [null, 1, *z_out, null, null]}
    - AffineTransformationDynamicTraining: {apply_to: pred, target_to_compare_to: ls_slice, meta: *meta}

model:
  name: A04
  kwargs:
    scale: *scale
    shrink: *shrink
    input_name: lfc
    prediction_name: pred
    nnum: *nnum
    z_out: *z_out
    n_res2d: [488, 488, u, 244, 244]

  checkpoint: "/g/kreshuk/LF_computed/lnet/logs/brain1/z_out49/f4_b2_only11_2/20-06-06_17-59-42/train/run000/checkpoints/v1_checkpoint_37500_MS_SSIM=0.8822072593371073.pth"

stages:
  - test_individually:
      metrics: *metrics
      log:
        TqdmLogger: {}
        TensorBoardLogger:
          scalars_every: {value: 1, unit: epoch}
          tensors_every: {value: 1, unit: epoch}
        FileLogger:
          scalars_every: {value: 1, unit: epoch}
          tensors_every: {value: 1, unit: iteration}
          tensor_names: {pred, ls_slice}
      batch_preprocessing: *eval_batch_prepr
      batch_preprocessing_in_step: *batch_prepr_in_step
      batch_postprocessing: *batch_postpr
      data:
        - batch_size: *eval_batch_size
          sample_preprocessing: *eval_sample_prepr
          filters: [[z_range, {}]]

      datasets:
#         - {tensors: {meta: *meta, lf: brain.09_1__2020-03-09_04.35.55__SinglePlane_-270, ls_slice: brain.09_1__2020-03-09_04.35.55__SinglePlane_-270},indices: null}  # 600
#         - {tensors: {meta: *meta, lf: brain.09_1__2020-03-09_04.35.55__SinglePlane_-280, ls_slice: brain.09_1__2020-03-09_04.35.55__SinglePlane_-280},indices: null}  # 600
#         - {tensors: {meta: *meta, lf: brain.09_1__2020-03-09_04.35.55__SinglePlane_-290, ls_slice: brain.09_1__2020-03-09_04.35.55__SinglePlane_-290},indices: null}  # 600 fish_09_1, quality *** (double check), better for testing, as only single planes, traces possible
#         - {tensors: {meta: *meta, lf: brain.09_1__2020-03-09_04.35.55__SinglePlane_-300, ls_slice: brain.09_1__2020-03-09_04.35.55__SinglePlane_-300},indices: null}  # 600
#         - {tensors: {meta: *meta, lf: brain.09_1__2020-03-09_04.35.55__SinglePlane_-310, ls_slice: brain.09_1__2020-03-09_04.35.55__SinglePlane_-310},indices: null}  # 600
#         - {tensors: {meta: *meta, lf: brain.09_1__2020-03-09_04.35.55__SinglePlane_-320, ls_slice: brain.09_1__2020-03-09_04.35.55__SinglePlane_-320},indices: null}  # 600
#         - {tensors: {meta: *meta, lf: brain.09_1__2020-03-09_04.35.55__SinglePlane_-330, ls_slice: brain.09_1__2020-03-09_04.35.55__SinglePlane_-330},indices: null}
#         - {tensors: {meta: *meta, lf: brain.09_1__2020-03-09_04.35.55__SinglePlane_-340, ls_slice: brain.09_1__2020-03-09_04.35.55__SinglePlane_-340},indices: null}
#         - {tensors: {meta: *meta, lf: brain.09_1__2020-03-09_02.53.02__SinglePlane_-350, ls_slice: brain.09_1__2020-03-09_02.53.02__SinglePlane_-350},indices: null}  # 3000
#         - {tensors: {meta: *meta, lf: brain.09_1__2020-03-09_02.53.02__SinglePlane_-360, ls_slice: brain.09_1__2020-03-09_02.53.02__SinglePlane_-360},indices: null}  # 3600
#         - {tensors: {meta: *meta, lf: brain.09_1__2020-03-09_02.53.02__SinglePlane_-370, ls_slice: brain.09_1__2020-03-09_02.53.02__SinglePlane_-370},indices: null}  # 3600
#         - {tensors: {meta: *meta, lf: brain.09_1__2020-03-09_02.53.02__SinglePlane_-380, ls_slice: brain.09_1__2020-03-09_02.53.02__SinglePlane_-380},indices: null}  # 3600
        - {tensors: {meta: *meta, lf: brain.09_3__2020-03-09_06.43.40__SinglePlane_-320, ls_slice: brain.09_3__2020-03-09_06.43.40__SinglePlane_-320},indices: null}  # 1200?
        - {tensors: {meta: *meta, lf: brain.09_3__2020-03-09_06.43.40__SinglePlane_-330, ls_slice: brain.09_3__2020-03-09_06.43.40__SinglePlane_-330},indices: null}  # 1200 crazy crazy blinking between 400-600
        - {tensors: {meta: *meta, lf: brain.09_3__2020-03-09_06.43.40__SinglePlane_-340, ls_slice: brain.09_3__2020-03-09_06.43.40__SinglePlane_-340},indices: null}  # 1200?
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.41.22__SinglePlane_-330, ls_slice: brain.09_4__2020-03-09_08.41.22__SinglePlane_-330},indices: null}  # 600
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.41.22__SinglePlane_-340, ls_slice: brain.09_4__2020-03-09_08.41.22__SinglePlane_-340},indices: null}  # 600
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.41.22__SinglePlane_-350, ls_slice: brain.09_4__2020-03-09_08.41.22__SinglePlane_-350},indices: null}  # 600
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.41.22__SinglePlane_-360, ls_slice: brain.09_4__2020-03-09_08.41.22__SinglePlane_-360},indices: null}  # 600
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.41.22__SinglePlane_-320, ls_slice: brain.09_4__2020-03-09_08.41.22__SinglePlane_-320},indices: null}  # 600
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.41.22__SinglePlane_-310, ls_slice: brain.09_4__2020-03-09_08.41.22__SinglePlane_-310},indices: null}  # 600
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.41.22__SinglePlane_-300, ls_slice: brain.09_4__2020-03-09_08.41.22__SinglePlane_-300},indices: null}  # 600
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_08.56.54__SinglePlane_-330, ls_slice: brain.09_4__2020-03-09_08.56.54__SinglePlane_-330},indices: null}  # 600
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-290, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-290},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-390, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-390},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-380, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-380},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-280, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-280},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-270, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-270},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-385, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-385},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-375, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-375},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-365, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-365},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-355, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-355},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-345, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-345},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-335, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-335},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-325, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-325},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-315, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-315},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-295, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-295},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-285, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-285},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-275, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-275},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-305, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-305},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-330, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-330},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-340, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-340},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-350, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-350},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-360, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-360},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-370, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-370},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-320, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-320},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-310, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-310},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_09.31.52__SinglePlane_-300, ls_slice: brain.09_4__2020-03-09_09.31.52__SinglePlane_-300},indices: null}  # 1200
# #         - {tensors: {meta: *meta, lf: brain.09_4__2020-03-09_07.53.40__SinglePlane_-330, ls_slice: brain.09_4__2020-03-09_07.53.40__SinglePlane_-330},indices: null}  # 600
# #         - {tensors: {meta: *meta, lf: brain.11_1__2020-03-11_02.34.23__SinglePlane_-330, ls_slice: brain.11_1__2020-03-11_02.34.23__SinglePlane_-330},indices: null}  # 300
# #         - {tensors: {meta: *meta, lf: brain.11_1__2020-03-11_03.22.33__SinglePlane_-330, ls_slice: brain.11_1__2020-03-11_03.22.33__SinglePlane_-330},indices: null}  # 150
# #         - {tensors: {meta: *meta, lf: brain.11_1__2020-03-11_04.25.22__SinglePlane_-330, ls_slice: brain.11_1__2020-03-11_04.25.22__SinglePlane_-330},indices: null}  # 150
# #         - {tensors: {meta: *meta, lf: brain.11_1__2020-03-11_03.43.42__SinglePlane_-330, ls_slice: brain.11_1__2020-03-11_03.43.42__SinglePlane_-330},indices: null}  # 150
# #         - {tensors: {meta: *meta, lf: brain.11_1__2020-03-11_03.48.47__SinglePlane_-330, ls_slice: brain.11_1__2020-03-11_03.48.47__SinglePlane_-330},indices: null}  # 150
# #         - {tensors: {meta: *meta, lf: brain.11_1__2020-03-11_04.00.37__SinglePlane_-330, ls_slice: brain.11_1__2020-03-11_04.00.37__SinglePlane_-330},indices: null}  # 150
# #         - {tensors: {meta: *meta, lf: brain.11_1__2020-03-11_06.07.48__SinglePlane_-330, ls_slice: brain.11_1__2020-03-11_06.07.48__SinglePlane_-330},indices: null}  # 600
# #         - {tensors: {meta: *meta, lf: brain.11_1__2020-03-11_06.07.48__SinglePlane_-340, ls_slice: brain.11_1__2020-03-11_06.07.48__SinglePlane_-340},indices: null}  # 600
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_07.30.39__SinglePlane_-320, ls_slice: brain.11_2__2020-03-11_07.30.39__SinglePlane_-320},indices: null}  # 600
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_07.30.39__SinglePlane_-310, ls_slice: brain.11_2__2020-03-11_07.30.39__SinglePlane_-310},indices: null}  # 600
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.13.20__SinglePlane_-290, ls_slice: brain.11_2__2020-03-11_10.13.20__SinglePlane_-290},indices: null}  # 600
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.13.20__SinglePlane_-315, ls_slice: brain.11_2__2020-03-11_10.13.20__SinglePlane_-315},indices: null}  # 600
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.25.41__SinglePlane_-295, ls_slice: brain.11_2__2020-03-11_10.25.41__SinglePlane_-295},indices: null}  # 600
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.25.41__SinglePlane_-305, ls_slice: brain.11_2__2020-03-11_10.25.41__SinglePlane_-305},indices: null}  # 600
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.25.41__SinglePlane_-340, ls_slice: brain.11_2__2020-03-11_10.25.41__SinglePlane_-340},indices: null}  # 600
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.17.34__SinglePlane_-280, ls_slice: brain.11_2__2020-03-11_10.17.34__SinglePlane_-280},indices: null}  # 600
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.17.34__SinglePlane_-330, ls_slice: brain.11_2__2020-03-11_10.17.34__SinglePlane_-330},indices: null}  # 600
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.21.14__SinglePlane_-295, ls_slice: brain.11_2__2020-03-11_10.21.14__SinglePlane_-295},indices: null}  # 600
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.21.14__SinglePlane_-305, ls_slice: brain.11_2__2020-03-11_10.21.14__SinglePlane_-305},indices: null}  # 600
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_08.12.13__SinglePlane_-310, ls_slice: brain.11_2__2020-03-11_08.12.13__SinglePlane_-310},indices: 0-430}  # 600 430-600 are black
        - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_06.53.14__SinglePlane_-330, ls_slice: brain.11_2__2020-03-11_06.53.14__SinglePlane_-330},indices: null}  # 150
#         - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.33.17__SinglePlane_-340, ls_slice: brain.11_2__2020-03-11_10.33.17__SinglePlane_-340},indices: null}
#         - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.34.15__SinglePlane_-340, ls_slice: brain.11_2__2020-03-11_10.34.15__SinglePlane_-340},indices: null}
#         - {tensors: {meta: *meta, lf: brain.11_2__2020-03-11_10.35.41__SinglePlane_-340, ls_slice: brain.11_2__2020-03-11_10.35.41__SinglePlane_-340},indices: null}
