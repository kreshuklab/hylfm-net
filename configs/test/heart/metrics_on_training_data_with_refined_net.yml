
toolbox: # defines yaml placeholders
  precision: &precision float
  nnum: &nnum 19
  z_out: &z_out 49
  meta: &meta {nnum: *nnum, z_out: *z_out, scale: &scale 4, shrink: &shrink 8, interpolation_order: 2, z_ls_rescaled: 241, pred_z_min: 0, pred_z_max: 838, crop_names: &crop_names [Heart_tightCrop, staticHeartFOV, wholeFOV]}  # z_min full: 0, z_max full: 838; 60/209*838=241; 838-10/209*838=798
  nshrink: &nshrink -8
  eval_batch_size: &eval_batch_size 1
  score_metric: &score_metric ms_ssim-scaled
  sample_trfs: &sample_trfs []
  eval_sample_prepr_dynamic: &eval_sample_prepr_dynamic
    - CropWhatShrinkDoesNot: {apply_to: lf, meta: *meta, wrt_ref: true}
    - CropLSforDynamicTraining: {apply_to: ls_slice, meta: *meta}
    - Normalize01: {apply_to: lf, min_percentile: 5.0, max_percentile: 99.8}
    - Normalize01: {apply_to: ls_slice, min_percentile: 5.0, max_percentile: 99.99}
    - ChannelFromLightField: {apply_to: {lf: lfc}, nnum: *nnum}
  train_sample_prepr_dynamic: &train_sample_prepr_dynamic
    - CropWhatShrinkDoesNot: {apply_to: lf, meta: *meta, wrt_ref: true}
    - CropLSforDynamicTraining: {apply_to: ls_slice, meta: *meta}
    - Normalize01: {apply_to: lf, min_percentile: 5.0, max_percentile: 99.8}
    - Normalize01: {apply_to: ls_slice, min_percentile: 5.0, max_percentile: 99.99}
    - AdditiveGaussianNoise: {apply_to: lf, sigma: 0.1}
    - AdditiveGaussianNoise: {apply_to: ls_slice, sigma: 0.05}
    - RandomIntensityScale: {apply_to: [lf, ls_slice], factor_min: .8, factor_max: 1.2}
    - RandomlyFlipAxis: {apply_to: [lf, ls_slice], axis: -1}
    - RandomlyFlipAxis: {apply_to: [lf, ls_slice], axis: -2}
  eval_sample_prepr_static: &eval_sample_prepr_static
    - CropWhatShrinkDoesNot: {apply_to: lf, meta: *meta, wrt_ref: true}
    - CropWhatShrinkDoesNot: {apply_to: ls_trf, meta: *meta, wrt_ref: false}
    - Crop: {apply_to: ls_trf, crop: [[0, null], [0, null], [*shrink, *nshrink], [*shrink, *nshrink]]}
    - Normalize01: {apply_to: lf, min_percentile: 5.0, max_percentile: 99.8}
    - Normalize01: {apply_to: ls_trf, min_percentile: 5.0, max_percentile: 99.99}
    - ChannelFromLightField: {apply_to: {lf: lfc}, nnum: *nnum}
  eval_batch_prepr: &eval_batch_prepr []
  train_batch_prepr: &train_batch_prepr
    - RandomRotate90: {apply_to: [lf, ls_slice]}
    - ChannelFromLightField: {apply_to: {lf: lfc}, nnum: *nnum}
  batch_prepr_in_step_dynamic: &batch_prepr_in_step_dynamic
    - Cast: {apply_to: [lfc, ls_slice], dtype: *precision, device: cuda, non_blocking: true}
  batch_prepr_in_step: &batch_prepr_in_step_static
    - Cast: {apply_to: [lfc, ls_trf], dtype: *precision, device: cuda, non_blocking: true}
  batch_postpr_dynamic: &batch_postpr_dynamic
    - Cast: {apply_to: lfc, dtype: *precision, device: cpu, non_blocking: true}
    - Assert: {apply_to: pred, expected_tensor_shape: [1, *z_out, null, null]}
    - AffineTransformationDynamicTraining: {apply_to: pred, target_to_compare_to: ls_slice, meta: *meta}
  batch_postpr: &batch_postpr_static
    - Assert: {apply_to: pred, expected_tensor_shape: [1, *z_out, null, null]}
    - Assert: {apply_to: pred, expected_tensor_shape: ls_trf}

  eval_filter_dynamic: &eval_filter_dynamic [[z_range, {}]]
  eval_metrics: &eval_metrics z49_heart_static.yml
  eval_log: &eval_log
    TqdmLogger: {}
    TensorBoardLogger:
      scalars_every: {value: 1, unit: epoch}
    FileLogger:
      scalars_every: {value: 1, unit: iteration}
#      tensors_every: {value: 1, unit: iteration}
#      tensor_names: {ls_slice, pred}

model:
  name: A04
  kwargs:
    scale: *scale
    shrink: *shrink
    input_name: lfc
    prediction_name: pred
    nnum: *nnum
    z_out: *z_out
    n_res2d: [488, 488, u, 244, 244]

  checkpoint: "/g/kreshuk/beuttenm/pycharm_tmp/repos/hylfm-net/logs/train/heart/refine_fish2_fullpred/from_static_heart/20-11-13_14-28-15/train_01/run000/checkpoints/v1_checkpoint_6600_ms_ssim-scaled=0.9658018271759073.pth"

stages:
  - training_scores_fish3:
      metrics: *eval_metrics
      log: *eval_log
      batch_preprocessing: *eval_batch_prepr
      batch_preprocessing_in_step: *batch_prepr_in_step_static
      batch_postprocessing: *batch_postpr_static
      data:
        - batch_size: *eval_batch_size
          sample_transformations: *sample_trfs
          sample_preprocessing: *eval_sample_prepr_static
          filters: []
          datasets:
            - {tensors: {lf: heart_static.2019-12-10_04.24.29, ls_trf: heart_static.2019-12-10_04.24.29, meta: *meta}} # fish3
            - {tensors: {lf: heart_static.2019-12-10_05.14.57, ls_trf: heart_static.2019-12-10_05.14.57, meta: *meta}} # fish3
            - {tensors: {lf: heart_static.2019-12-10_05.41.48, ls_trf: heart_static.2019-12-10_05.41.48, meta: *meta}} # fish3
            - {tensors: {lf: heart_static.2019-12-10_06.03.37, ls_trf: heart_static.2019-12-10_06.03.37, meta: *meta}} # fish3
            - {tensors: {lf: heart_static.2019-12-10_06.25.14, ls_trf: heart_static.2019-12-10_06.25.14, meta: *meta}} # fish3
  - training_scores_fish1:
      metrics: *eval_metrics
      log: *eval_log
      batch_preprocessing: *eval_batch_prepr
      batch_preprocessing_in_step: *batch_prepr_in_step_static
      batch_postprocessing: *batch_postpr_static
      data:
        - batch_size: *eval_batch_size
          sample_transformations: *sample_trfs
          sample_preprocessing: *eval_sample_prepr_static
          filters: []
          datasets:
            - {tensors: {lf: heart_static.2019-12-09_02.16.30, ls_trf: heart_static.2019-12-09_02.16.30, meta: *meta}} # fish1
            - {tensors: {lf: heart_static.2019-12-09_02.23.01, ls_trf: heart_static.2019-12-09_02.23.01, meta: *meta}} # fish1
            - {tensors: {lf: heart_static.2019-12-09_02.29.34, ls_trf: heart_static.2019-12-09_02.29.34, meta: *meta}} # fish1
            - {tensors: {lf: heart_static.2019-12-09_02.35.49, ls_trf: heart_static.2019-12-09_02.35.49, meta: *meta}} # fish1
            - {tensors: {lf: heart_static.2019-12-09_02.42.03, ls_trf: heart_static.2019-12-09_02.42.03, meta: *meta}} # fish1
            - {tensors: {lf: heart_static.2019-12-09_02.48.24, ls_trf: heart_static.2019-12-09_02.48.24, meta: *meta}} # fish1
            - {tensors: {lf: heart_static.2019-12-09_02.54.46, ls_trf: heart_static.2019-12-09_02.54.46, meta: *meta}} # fish1
  - training_scores_fish5:
      metrics: *eval_metrics
      log: *eval_log
      batch_preprocessing: *eval_batch_prepr
      batch_preprocessing_in_step: *batch_prepr_in_step_static
      batch_postprocessing: *batch_postpr_static
      data:
        - batch_size: *eval_batch_size
          sample_transformations: *sample_trfs
          sample_preprocessing: *eval_sample_prepr_static
          filters: []
          datasets:
            - {tensors: {lf: heart_static.2019-12-08_06.10.34, ls_trf: heart_static.2019-12-08_06.10.34, meta: *meta}, indices: 1-5} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.18.09, ls_trf: heart_static.2019-12-08_06.18.09, meta: *meta}, indices: 1-5} # fish5 val selected
#            - {tensors: {lf: heart_static.2019-12-08_06.23.13, ls_trf: heart_static.2019-12-08_06.23.13, meta: *meta}, indices: 1-1} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.25.02, ls_trf: heart_static.2019-12-08_06.25.02, meta: *meta}, indices: 1-5} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.30.40, ls_trf: heart_static.2019-12-08_06.30.40, meta: *meta}, indices: 1-5} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.35.52, ls_trf: heart_static.2019-12-08_06.35.52, meta: *meta}, indices: 1-5} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.38.47, ls_trf: heart_static.2019-12-08_06.38.47, meta: *meta}, indices: 1-5} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.41.39, ls_trf: heart_static.2019-12-08_06.41.39, meta: *meta}, indices: 1-5} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.46.09, ls_trf: heart_static.2019-12-08_06.46.09, meta: *meta}, indices: 1-5} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.49.08, ls_trf: heart_static.2019-12-08_06.49.08, meta: *meta}, indices: 1-5} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.51.57, ls_trf: heart_static.2019-12-08_06.51.57, meta: *meta}, indices: 1-5} # fish5 val selected
  - validation_scores:
      metrics: *eval_metrics
      log: *eval_log
      batch_preprocessing: *eval_batch_prepr
      batch_preprocessing_in_step: *batch_prepr_in_step_static
      batch_postprocessing: *batch_postpr_static
      data:
        - batch_size: *eval_batch_size
          sample_transformations: *sample_trfs
          sample_preprocessing: *eval_sample_prepr_static
          filters: []
          datasets:
            - {tensors: {lf: heart_static.2019-12-08_06.35.52, ls_trf: heart_static.2019-12-08_06.35.52, meta: *meta}, indices: 0} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.38.47, ls_trf: heart_static.2019-12-08_06.38.47, meta: *meta}, indices: 0} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.10.34, ls_trf: heart_static.2019-12-08_06.10.34, meta: *meta}, indices: 0} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.41.39, ls_trf: heart_static.2019-12-08_06.41.39, meta: *meta}, indices: 0} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.18.09, ls_trf: heart_static.2019-12-08_06.18.09, meta: *meta}, indices: 0} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.46.09, ls_trf: heart_static.2019-12-08_06.46.09, meta: *meta}, indices: 0} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.23.13, ls_trf: heart_static.2019-12-08_06.23.13, meta: *meta}, indices: 0} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.49.08, ls_trf: heart_static.2019-12-08_06.49.08, meta: *meta}, indices: 0} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.25.02, ls_trf: heart_static.2019-12-08_06.25.02, meta: *meta}, indices: 0} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.51.57, ls_trf: heart_static.2019-12-08_06.51.57, meta: *meta}, indices: 0} # fish5 val selected
            - {tensors: {lf: heart_static.2019-12-08_06.30.40, ls_trf: heart_static.2019-12-08_06.30.40, meta: *meta}, indices: 0} # fish5 val selected